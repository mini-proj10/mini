# 프롬프트 정책 문서

## 개요

이 프로젝트는 **영양·맛·날씨·거리**를 함께 고려하여 점심 메뉴를 추천하는 AI 시스템입니다.

## 시스템 프롬프트 규칙

### 목표
사용자의 입력(구내식당 금일 메뉴, 위치, 선호 이동 거리, 날씨)을 바탕으로 **카카오맵에 실제 등록된 인근 음식점**만 사용하여 **최대 3개**의 대안을 추천합니다.

### 출력 형식
- **유효한 JSON만** 허용
- 코드블록·여분 텍스트·이모지 금지
- 각 추천의 설명은 **1–2문장**, **반말 금지**, **친근하지만 부드러운 톤**
- 추천 이유에는 **맛·재료·영양·날씨** 중 **최소 2개**의 근거를 반드시 포함

### 추천 카테고리
1. **상위 호환 메뉴**: 구내식당 메뉴의 고급/프리미엄 버전
2. **대체 메뉴**: 같은 계열이지만 다른 음식
3. **예외 메뉴**: 날씨 기반, 완전히 다른 종류의 음식

## 입력 검증 규칙

### 메뉴명 검증
- 메뉴명은 **완성형 한글 2자 이상** 또는 **영문/숫자 2자 이상**이어야 함
- **한글 자모(ㄱ/ㄴ/ㅇ/ㅐ 등)**만으로 이루어진 입력은 무효
- 음식명이 아닌 단어 필터링:
  - "그림", "사진", "이미지", "파일", "텍스트", "문장", "단어"
  - "테스트", "추천", "메뉴", "배고파" 등

### 검증 실패 시 응답
```json
{
  "recommendations": [],
  "brief_rationale": "메뉴명이 음식으로 인식되지 않거나 길이가 너무 짧습니다.",
  "need_more_info": true,
  "missing": ["valid_food_name(예: 김치찌개/파스타/초밥 등)"]
}
```

## 출력 스키마

```json
{
  "recommendations": [
    {
      "type": "상위 호환 메뉴 | 대체 메뉴 | 예외 메뉴",
      "restaurant_name": "string",
      "place_id": "string",
      "minutes_away": 0,
      "menu_name": "string",
      "price_range": "string",
      "reason": "string (1-2문장, 맛/재료/영양/날씨 중 최소 2개 근거 포함)",
      "normalized_search_query": "string (대표 키워드 1개)",
      "alt_queries": ["string", "..."],
      "category_group_code": "FD6"
    }
  ],
  "brief_rationale": "string (1-2문장)",
  "need_more_info": false,
  "missing": []
}
```

## 필수 제약

### 데이터 소스
- 반드시 `nearbyCandidates`에 포함된 가게만 사용 (카카오맵 등록 보장)

### 거리 제약
- `distancePref`를 초과하는 후보는 제외
- `0-5`분 → 반경 약 **400m** 가정
- `5-15`분 → 반경 약 **1200m** 가정 (보행 80m/분)

### 정렬 기준
- **예외 메뉴**: 날씨 적합도 > 도보 거리 > 품질
- **상위호환/대체 메뉴**: 메뉴 연관성 > 거리 > 품질

### 중복 방지
- 동일 가게/메뉴 중복 금지
- **최대 3개** 추천

### 톤/길이
- 사유는 1–2문장
- 반말 금지, 친근하지만 부드럽게

### 정합성
- 추천 메뉴는 해당 가게의 `menuExamples` 또는 합리적 범주의 대표 메뉴
- 과도한 추측 금지

## 카카오맵 검색 정규화 규칙

### 목표
추천된 **구체 메뉴명 → 실제 검색 가능한 대표 키워드**로 변환하여 카카오맵 검색 적합성을 보장

### 변환 파이프라인

1. **불용어/수식어 제거**
   - 제거 예: `런치/세트/정식/특/곱빼기/추천/한정/든든한/가성비/프로모션`
   - 예) `런치 초밥세트` → `초밥`

2. **형태 통일**
   - 예) `함박 스테이크` → `함박스테이크`, `돈-카츠` → `돈까스`

3. **대표 키워드 선택**
   - 가장 일반적·범용적인 **대표 1어**를 `normalized_search_query`로 지정
   - 예) `모둠초밥` → `초밥`

4. **보조 키워드 구성**
   - 검색 실패 대비 **1–3개 동의어/상하위 카테고리**를 `alt_queries`에 제공
   - 예) `초밥`의 보조: `스시`, `모둠초밥`

5. **카테고리 그룹코드**
   - 음식점: `FD6`
   - 카페·디저트: `CE7`

## 구현 위치

- **시스템 프롬프트**: `backend/services/ai_service.py` - `_get_system_instruction()` 메서드
- **입력 데이터 구조화**: `backend/services/ai_service.py` - `recommend_from_cafeteria_menu()` 메서드
- **후보 생성**: `backend/services/ai_service.py` - `_generate_nearby_candidates()` 메서드
- **날씨 정규화**: `backend/services/ai_service.py` - `_normalize_weather_condition()` 메서드
- **프론트엔드 검증**: `frontend/src/utils/menuValidation.jsx`
- **Alert 컴포넌트**: `frontend/src/components/AlertBanner.jsx`

## 업데이트 이력

- **2025-10-29**: 리팩터링 적용
  - 입력 검증 규칙 강화 (한글 자모 필터링)
  - AlertBanner 컴포넌트 추가
  - menuValidation.jsx 유틸리티 추가
  - 프론트엔드-백엔드 검증 로직 통합
  - 사용자 피드백 개선
