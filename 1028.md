# 2025-10-28 개발 일지

## 📌 작업 요약
- **프로젝트**: 밥뭇나?! (AI 점심 메뉴 추천 서비스)
- **작업 기간**: 2025-10-28
- **커밋 횟수**: 5회
- **주요 작업**: 메뉴 검색 키워드 정제, 날씨 기반 동적 배경 구현, Open-Meteo API 통합

---

## 🚀 주요 변경 사항

### 1️⃣ 커밋: `develop first` (33c548d)
**시간**: 6시간 전

#### 변경 내용
- 구내식당 메뉴 기반 추천 시스템 구축
- CAM(Cafeteria Avoidance Mode) 모드 도입
- 기본 UI 컴포넌트 구성

#### 주요 파일
```
- backend/main.py              # FastAPI 서버 초기화
- backend/services/ai_service.py  # Gemini AI 서비스
- frontend/src/App_Cafeteria.jsx  # 구내식당 전용 앱
- frontend/src/components/
  - CafeteriaInput.jsx         # 메뉴 입력 화면
  - CafeteriaResult.jsx        # 추천 결과 화면
  - RestaurantPage.jsx         # 카카오맵 연동
  - RouletteGame.jsx           # 룰렛 게임
```

#### 기술 스택
- **백엔드**: FastAPI, Gemini 2.0 Flash
- **프론트엔드**: React 18 + Vite
- **API**: Kakao Map API

---

### 2️⃣ 커밋: `2nd` (2a22c54)
**시간**: 6시간 전

#### 변경 내용
- Conda 환경 설정 추가 (`environment.yml`)
- Python 3.12 기반 가상환경 구성
- README 업데이트

#### 주요 의존성
```yaml
dependencies:
  - python=3.12
  - pip
  - pip:
    - fastapi
    - uvicorn
    - google-generativeai
    - python-dotenv
    - httpx
```

---

### 3️⃣ 커밋: `3thapi` (62302b3)
**시간**: 3시간 전

#### 변경 내용
- **Open-Meteo Weather API 통합** (무료, 빠른 응답)
- 고급 프롬프트 시스템 문서화 (`ADVANCED_PROMPT_GUIDE.md`)
- 날씨 기반 메뉴 추천 로직 강화

#### 핵심 기능: Weather Service
```python
# backend/services/weather_service.py
class WeatherService:
    def __init__(self):
        self.base_url = "https://api.open-meteo.com/v1/forecast"
    
    async def get_weather(self, location: str) -> Dict:
        # Open-Meteo API로 실시간 날씨 조회
        # 기상청 API 대비 빠른 응답 (0.5초 이내)
```

#### AI 프롬프트 시스템 개선
- **CAM 모드 정교화**: 외부식당 우선 추천
- **스코어링 가중치 차별화**:
  - 기본 모드: taste 3 : nutrition 4 : practicality 3
  - CAM 모드: taste 3 : nutrition 3 : practicality 4
- **거리 정책**: 도보 0~15분 범위
  - near: 0~5분
  - mid: 6~15분

---

### 4️⃣ 커밋: `4nd` (ab6f6e1)
**시간**: 3시간 전

#### 변경 내용
**문제 발견**: AI 추천 메뉴명이 너무 상세해서 카카오맵 검색 실패
- 예시: "따뜻한 생선구이" → 검색 결과 없음 ❌
- 실제로는 "생선구이"로 검색해야 함 ✅

#### 해결 방법 1: AI 프롬프트 수정
```python
# backend/services/ai_service.py
user_message = f"""
**중요 규칙**:
1. **menu** 필드는 지도 검색용으로 수식어 없이 간결하게 작성하세요.
   - 좋은 예: "생선구이", "냉면", "김치찌개"
   - 나쁜 예: "따뜻한 생선구이", "시원한 평양냉면"
2. **display_name** 필드는 사용자에게 보여줄 풍부한 표현으로 작성하세요.
"""
```

#### 해결 방법 2: 프론트엔드 키워드 추출
```javascript
// frontend/src/components/RestaurantPage.jsx
const extractCoreKeyword = (name) => {
  const modifiers = [
    '따뜻한', '시원한', '차가운', '뜨거운', '얼큰한', '매운',
    '고급', '프리미엄', '특별한', '신선한', // ...
  ];
  
  let keyword = name.trim();
  modifiers.forEach(modifier => {
    keyword = keyword.replace(new RegExp(`^${modifier}\\s*`, 'g'), '');
  });
  
  return keyword.trim() || name;
};
```

#### 적용 결과
- **AI 응답**: 
  ```json
  {
    "menu": "생선구이",           // 검색용
    "display_name": "따뜻한 생선구이 정식"  // 표시용
  }
  ```
- **UI 표시**: "따뜻한 생선구이 정식" 👁️
- **지도 검색**: "생선구이" 🔍

---

### 5️⃣ 커밋: `5nd` (c673638)
**시간**: 62분 전

#### 변경 내용
**날씨 기반 동적 배경 시스템 구현** 🎨

#### 1) Unsplash API 통합
```python
# backend/services/unsplash_service.py
class UnsplashService:
    async def get_weather_photo(self, weather_condition: str, temperature: float):
        # 날씨별 키워드 매핑
        keywords = {
            "맑음": ["sunny sky", "clear blue sky", "bright day"],
            "비": ["rain", "rainy weather", "umbrella"],
            "눈": ["snow", "snowy landscape", "winter"],
            "구름많음": ["cloudy sky", "clouds"],
        }
        
        # Unsplash API로 사진 검색
        # 폴백: CSS 그라데이션
```

#### 2) 날씨별 테마 시스템
```css
/* frontend/src/index.css */
.theme-clear {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.theme-rain {
  background: linear-gradient(135deg, #4b79a1 0%, #283e51 100%);
}

.theme-snow {
  background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
}

.theme-hot {
  background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
}
```

#### 3) Glassmorphism UI
```css
.glass {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.18);
}
```

#### 4) 날씨 표시 컴포넌트
```javascript
// frontend/src/components/WeatherDisplay.jsx
const WeatherDisplay = ({ weather }) => {
  return (
    <div className="glass rounded-lg shadow-lg p-6">
      <h2>현재 날씨 {getWeatherIcon(weather.sky_condition)}</h2>
      <div className="grid grid-cols-2 gap-4">
        <div>위치: {weather.location}</div>
        <div>기온: {weather.temperature}°C</div>
        <div>날씨: {weather.sky_condition}</div>
        <div>습도: {weather.humidity}%</div>
      </div>
    </div>
  );
};
```

#### 5) 적용 범위
- ✅ 구내식당 입력 화면 (`CafeteriaInput`)
- ✅ 추천 결과 화면 (`CafeteriaResult`)
- ✅ 룰렛 게임 화면 (`RouletteGame`)
- ✅ 식당 지도 화면 (`RestaurantPage`)
- ❌ 랜딩 페이지 (의도적 제외)

---

## 🐛 발견된 문제점

### 문제 1: 위치 정보 부정확성
**증상**: 강남에 있는데 "서울" 날씨 표시

**원인 분석**:
```javascript
// frontend/src/App.jsx (107-108줄)
navigator.geolocation.getCurrentPosition(
  async (position) => {
    setUserCoords(coords);  // GPS 좌표 저장은 함
    
    setLocation('서울');           // ❌ 하드코딩!
    await fetchWeather('서울');    // ❌ 하드코딩!
  }
);
```

**현재 동작**:
- GPS 좌표는 받지만 날씨는 무조건 "서울"로 조회
- 식당 검색: 실제 GPS 사용 ✅
- 날씨 정보: "서울" 고정 ❌

**영향**:
- 날씨와 식당 위치의 불일치 (약 1km 오차)
- 사용자 경험 저하

---

## 💡 해결 방안 (미구현)

### 좌표 기반 날씨 조회 API 추가

#### 백엔드
```python
# backend/main.py
@app.get("/api/weather-by-coords")
async def get_weather_by_coords(lat: float, lon: float):
    weather_data = await weather_service.get_weather_by_coords(lat, lon)
    return {"success": True, "data": weather_data}

# backend/services/weather_service.py
async def get_weather_by_coords(self, lat: float, lon: float) -> Dict:
    """GPS 좌표로 직접 날씨 조회"""
    params = {
        "latitude": lat,
        "longitude": lon,
        "current": "temperature_2m,weather_code,precipitation",
        "timezone": "Asia/Seoul"
    }
    # Open-Meteo API 호출
    # 지역명 추정 로직 추가
```

#### 프론트엔드
```javascript
// frontend/src/App.jsx
navigator.geolocation.getCurrentPosition(
  async (position) => {
    const { latitude, longitude } = position.coords;
    
    // 실제 GPS 좌표로 날씨 조회!
    await fetchWeatherByCoords(latitude, longitude);
  }
);
```

---

## 📊 기술 아키텍처

```
┌─────────────────────────────────────────────────────┐
│                   Frontend (React)                   │
├─────────────────────────────────────────────────────┤
│  - 위치 권한 요청 (navigator.geolocation)            │
│  - 날씨 기반 동적 배경 (Unsplash)                    │
│  - 메뉴 입력 (텍스트/이미지)                         │
│  - AI 추천 결과 표시                                 │
│  - 룰렛 게임                                         │
│  - 카카오맵 식당 검색                                │
└─────────────────────────────────────────────────────┘
                          │
                          ↓ HTTP/REST API
┌─────────────────────────────────────────────────────┐
│               Backend (FastAPI)                      │
├─────────────────────────────────────────────────────┤
│  • /api/weather                                      │
│    - Open-Meteo API (무료, 0.5초 응답)              │
│  • /api/recommend-from-cafeteria                     │
│    - Gemini 2.0 Flash AI                            │
│    - CAM 모드 지원                                   │
│  • /api/weather-photo                                │
│    - Unsplash API (날씨별 배경)                      │
└─────────────────────────────────────────────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────┐
│              External APIs                           │
├─────────────────────────────────────────────────────┤
│  - Open-Meteo (날씨)                                 │
│  - Google Gemini 2.0 Flash (AI)                     │
│  - Unsplash (사진)                                   │
│  - Kakao Map (지도/검색)                             │
└─────────────────────────────────────────────────────┘
```

---

## 🎯 핵심 기능

### 1. CAM 모드 (Cafeteria Avoidance Mode)
- 외부식당 우선 추천
- 도보 0~15분 범위 제한
- 스코어링 가중치 차별화

### 2. 3가지 추천 카테고리
1. **상위호환**: 구내식당 메뉴의 프리미엄 버전
2. **비슷한 카테고리**: 같은 계열의 다른 음식
3. **날씨 기반 예외**: 완전히 다른 음식

### 3. 지도 검색 키워드 정제
- AI: `menu` (검색용) + `display_name` (표시용)
- Frontend: `extractCoreKeyword()` 안전망

### 4. 날씨 기반 UI
- 동적 배경 (Unsplash)
- 날씨별 테마 (CSS 그라데이션)
- Glassmorphism 효과

---

## 📈 성능 개선

### Open-Meteo API 선택 이유
| 항목 | KMA (기상청) | Open-Meteo |
|------|-------------|------------|
| **응답 속도** | 3-5초 ❌ | 0.3-0.5초 ✅ |
| **API 키** | 필요 | 불필요 ✅ |
| **정확도** | 높음 | 충분함 |
| **무료 사용** | 제한적 | 무제한 ✅ |

**결정**: Open-Meteo 채택 (KMA에서 롤백)

---

## 🔧 환경 설정

### Conda 가상환경
```bash
conda env create -f environment.yml
conda activate ai_x2
```

### 백엔드 실행
```bash
cd backend
python main.py
# http://localhost:8000
```

### 프론트엔드 실행
```bash
cd frontend
npm install
npm run dev
# http://localhost:5173
```

---

## 🎨 UI/UX 개선 사항

### 1. Glassmorphism 디자인
- 반투명 배경 (`rgba(255, 255, 255, 0.15)`)
- 블러 효과 (`backdrop-filter: blur(10px)`)
- 부드러운 테두리

### 2. 날씨별 테마
- 맑음: 보라색 그라데이션 🌞
- 비: 어두운 청회색 🌧️
- 눈: 밝은 하늘색 ❄️
- 더움: 빨강-노랑 🔥
- 추움: 파랑 계열 ⛄

### 3. 반응형 디자인
- 모바일 최적화
- TailwindCSS 기반
- DaisyUI 컴포넌트

---

## 📝 다음 작업 예정

### 우선순위 1: 위치 정확도 개선 🔴
- [ ] `GET /api/weather-by-coords` 엔드포인트 추가
- [ ] `get_weather_by_coords()` 메서드 구현
- [ ] 좌표 → 지역명 변환 로직
- [ ] 프론트엔드 연동

### 우선순위 2: 정확도 표시 🟡
- [ ] GPS 정확도 반경 표시 (Circle)
- [ ] 정확도 낮을 시 경고 메시지
- [ ] 검색 반경 자동 조정

### 우선순위 3: 사용자 경험 🟢
- [ ] 여러 번 측정 → 최고 정확도 선택
- [ ] 지도 클릭으로 위치 수정
- [ ] 로딩 상태 개선

---

## 📚 참고 문서
- `ADVANCED_PROMPT_GUIDE.md`: AI 프롬프트 시스템
- `README.md`: 프로젝트 개요
- `newui.txt`: 초기 기획

---

## 🏷️ Git 커밋 히스토리
```
c673638 - 5nd (62분 전)
  - 날씨 기반 동적 배경 시스템 (Unsplash)
  - Glassmorphism UI
  - 모든 화면에 날씨 표시

ab6f6e1 - 4nd (3시간 전)
  - 메뉴 검색 키워드 정제 (AI + Frontend)
  - menu/display_name 분리

62302b3 - 3thapi (3시간 전)
  - Open-Meteo API 통합
  - 고급 프롬프트 시스템

2a22c54 - 2nd (6시간 전)
  - Conda 환경 설정

33c548d - develop first (6시간 전)
  - 초기 프로젝트 구조
  - CAM 모드 도입
```

---

## 💬 개발 소감

### 성과
1. ✅ 카카오맵 검색 실패 문제 해결 (키워드 정제)
2. ✅ 날씨 기반 동적 배경 구현
3. ✅ Open-Meteo로 빠른 응답 속도 확보
4. ✅ Glassmorphism으로 세련된 UI

### 과제
1. ⚠️ GPS 좌표 활용 미흡 (날씨 조회에 미사용)
2. ⚠️ 위치 정확도 표시 부재
3. ⚠️ 에러 핸들링 강화 필요

### 개선 방향
- 좌표 기반 날씨 API 우선 적용
- 사용자 피드백 수집
- 성능 모니터링 추가

---

**작성일**: 2025-10-28  
**작성자**: AI Development Assistant  
**프로젝트**: 밥뭇나?! (밥 뭐 먹나?)


